# 2. 功能性需求 (Functional Requirements)

## 数据处理与索引流程

* **FR1: 文档处理与分块**
    * 系统必须能够读取 `corpus.json` 格式的文档列表。
    * 根据 `chinese_text_splitter.py` 中的策略，每个文档的完整 `text` 字段应被视为一个独立的、无需切分的文本块（Chunk）。

* **FR2: 命名实体识别 (NER)**
    * 对于每一个文本块，系统应调用大语言模型（LLM），使用 `ner_chinese.py` 中定义的Prompt模板来提取所有的命名实体。

* **FR3: 关系抽取 (RE)**
    * 对于每一个文本块及其对应的已提取命名实体列表（FR2的输出），系统应调用LLM，使用 `triple_extraction_chinese.py` 中定义的Prompt模板来抽取出所有的关系三元组。

* **FR4: 统一知识图谱构建**
    * 系统必须能将从所有文档中抽取出的三元组（FR3的输出）聚合起来，构建一个单一的、全局的知识图谱。
    * 图谱构建过程中需要进行实体去重和关系合并。

* **FR5: 文本嵌入 (Text Embedding)**
    * 系统应使用 `basic_embedding_advanced.py` 脚本中的 `Qwen3EmbeddingManager`，对所有从FR1中产生的文本块进行向量化，生成嵌入向量。

* **FR6: 向量化索引 (Vector Indexing)**
    * 系统需将FR5生成的嵌入向量及其元数据存入一个向量数据库中。
    * 元数据至少应包括：对应的公司名称 (`title`)、原始索引 (`idx`)、以及文本块内容本身。

## 问答（QA）流程

* **FR7: 查询意图识别 (Query Intent Detection)**
    * 系统必须首先对用户的查询进行意图分析，判断其属于“事实问答”还是“关联性发现”。
    * a. 若查询包含“相似”、“关联”、“类似”、“竞品”、“上下游”等词语，则判定为“**关联性发现**”。
    * b. 否则，默认判定为“**事实问答**”。
    * c. 对于包含两种意图的模糊查询，系统应优先执行“**事实问答**”，并在返回结果中提示用户可以进行“关联性发现”。

---
### ► 分支 A：如果意图为“事实问答”

* **FR-A1: 向量检索 (Vector Retrieval)**
    * 系统根据问题中的公司实体，在向量数据库中检索最相关的文本块。
* **FR-A2: 结果重排序 (Reranking)**
    * 系统使用 `qwen3_reranker_official_best_practice.py` 的逻辑对检索结果进行相关性重排序。
* **FR-A3: 摘要回答与溯源**
    * 系统将重排后的文本块交给LLM，并要求LLM根据这些内容，直接总结回答用户的问题。
    * 答案必须附带来源文本块作为出处。

---
### ► 分支 B：如果意图为“关联性发现”

* **FR-B1: 混合检索 (Hybrid Retrieval)**
    * 系统执行向量检索和图谱检索的混合策略。
* **FR-B2: 结果重排序 (Reranking)**
    * 系统使用 `qwen3_reranker_official_best_practice.py` 的逻辑进行重排序。
* **FR-B3: 事实过滤 (Fact Filtering)**
    * 系统使用 `filter_deepseek-v3-instruct.json` 的逻辑进行事实过滤。
* **FR-B4: 结构化答案生成与溯源**
    * 系统使用 `rag_qa_chinse_companies.py` 的逻辑生成结构化的关联公司答案。
    * 最终输出的结构化答案中，除了包含一个0到1之间、用于排序的数字“相似度分数”外，**必须**额外包含一个`relevance_level`（相关性等级）字段。该字段的值应为 `NFR2` 中定义的三个等级之一。

---
* **FR12 (异常处理)**
    * a. 当查询的公司在我们的数据集中不存在时，系统应返回明确的“公司未找到”提示。
    * b. 当“关联性发现”没有找到任何符合条件的公司时，系统应返回“未找到相关公司”的提示。
